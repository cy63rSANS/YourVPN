#cloud-config
groups:
  - docker: [vpnmgr, netadmin]
  - headscaleusers:
users:
  - default
  - name: vpnmgr
    gecos: vpnmgr
    primary_group: vpnmgr
    groups: users
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    hashed_passwd: $y$j9T$NeGvgBA87YzAExelYJ/OP.$G0K1qZn8SQZ7AvQnjNMmHhRoqsiG0rV0t1Pl18BJkI4
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC6/fB4NNy2k+oAHA4Q4pOUCdH997mQq9BtxoOx99MdS+cRKYITVlN1VaLW+beYgTtTYLRdrJhgPBCk9BzriUEXhFO1D6cOslkCxHsQO5M8FPJEU+I/OSRvpU2QYnhYwP9RRKs1XjwdJ2sg924xYLHdfqcRazRFdLGmKnmz8lLrhz0HrBaBIG8Qm58YpfSrkEQ6eAs+1Xf/1VlCTN4sKq2lwLYGFv8GkMOPRndhiEEc5HTZPfGtOp928xJR63WxUoWn2deDGQxU+Z3wGlZ4Ag0SHGM6uZkaRD+LYZHj+m7J979SJ2uqiLC4YCMjoQF5yqUgsu6bzvVh5TesrW2FZ1PrdWjxZGkmS7gv5PJnAdJ4xKLuuG9Bq5QZmWSTPMaKo6Z23HbAbmBj1stUfNbF7apt+GPiGjR4yZk5+tNCQ2n5fRCufNdsFyeBIXnx6MMugbKq2O70F365fyVNR0otleISpmnpnPlfG+n/+rhdf6w5+b0SYaJ3bBYMdXCrTZ8lj68= x0f@cy63r.ninja
package_update: true
package_upgrade: true
packages:
  - docker
  - docker-compose
  - wireguard
write_files:
  - path: /home/vpnmgr/config.sh
    permissions: "0775"
    content: |
      #!/bin/bash
      sed -i s/YOURDOMAIN.COM/"$1"/g /containers/caddy/Caddyfile
      sed -i s/YOURDOMAIN.COM/"$1"/g /containers/headscale/config/config.yaml
      sed -i s/YOURSECRET/"$2"/g /containers/pihole/docker-compose.yaml
      sudo cd /containers/caddy
      sudo docker-compose up -d
      sudo cd /containers/headscale
      sudo docker-compose up -d
      sudo cd /containers/pihole
      sudo docker-compose up -d
    owner: vpnmgr:vpnmgr
runcmd:
  - curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-arch>  
  - curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d> 
  - sudo apt update
  - sudo apt install tailscale -y
  - sudo docker network create reverseproxy-nw
  - sudo mkdir -p /source
  - cd /source
  - sudo git clone https://github.com/cy63rSANS/YourVPN
  - sudo cp -r YourVPN/fileStructure/containers /containers
  - sudo chown -r vpnmgr:docker /containers
  - sudo echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
  - sudo echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
  - sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
